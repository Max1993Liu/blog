异常检测系列之基于统计检验的时序异常检测


1. 时序数据的预处理
	
	在对时序数据进行异常检测之前，通常需要进行一些预处理，最常见的预处理步骤有取对数，趋势分解，中值滤波等。

	1）对数变换
	数值预处理比较常见的是取对数和Box-Cox转换。转换的主要目的是让数值更加接近标准的正态分布，我们知道有很多统计检验的前提条件是数据近似符合正态分布，但是在绝大多数场景下我们接触到的数据都是呈现肥尾特征的,下图展示了包钢股份2015年至今的股价分布（对数转换前后）。

	Box-Cox变换相传是George Box和David Cox第一次见面时因为名字相近又同为英国人决定合作一篇文章，因此就诞生了这个经典的转换，可以看到对数变换是Box-Cox的一种特例:
	[box_cox_formula]

	那Box-Cox转换中的参数lambda该如何取值呢？**对于右偏（长尾在右侧）的数据lambda取小于0，左偏的数据lambda取大于0**，背后的原因我们先看下图，对数函数在左侧的变化更快，所以对原数据起到了
	[log_transform_example]

	针对不同lambda取值的函数图像如下:
	[box-cox illustration]

	
	b. 趋势分解。statsmodels.tsa.seasonal

	时间序列的趋势分解是将数据分解成**趋势项(trend)**, **季节项(seasonal)**, **剩余项(residual)**。进行趋势分解的目的是防止长期的趋势和有规律的季节性波动影响异常检测的准确性。

	[stl_example]

	值得注意的是，对于一些没有明显周期性的数据进行趋势分解也能得到趋势和周期项。例如下图中我们对一列随机数进行趋势分解，乍一看也找到了趋势项和周期项，但其实这些都只是噪声。一个比较好的判断方法是对比剩余项(resid)和周期项(season)的数值范围大小，一般只有当**周期项的数值明显大于剩余项**时才认为趋势分解是比较有效的。

	[stl_random]

	c. 中值滤波。

	现实中我们拿到的时序数据可能会由于一些外部因素出现噪音和脏数据（例如传感器突然失效），这时我们就可以用中值滤波来把这些噪声点平滑掉。具体方法就是将数据中的每一个点替换成附近一个小窗口内的中值(median)，效果如下：

	[median filter example]


2. 常见的异常模式及检验方式


	1. 趋势突变（尖峰波谷）
	[peak example]

	时间序列中一种常见的异常场景是突然出现的尖峰和波谷。针对这样的异常模式一种很自然的想法就是计算数据点相对于样本均值的偏离度，Grubbs' test就是基于这个想法来检验数据中是否存在**单个**异常点。

	[Grubb test formula 1]
	上式计算了样本中偏离度最大的点A相较均值偏离了几个标准差，记作G。之后将G与一个基于student t分布的关键值(critical value)进行比较，如果G>关键值则判定点A为异常点。这个关键值的计算公式虽然看起来有点复杂，但我们可以画出关键值和样本量的变化趋势：
	[critical value vs. sample size]
	可以看到关键值随着样本量的增大而逐渐增大，换句话来说就是**样本量越大，我们就需要更加确凿的证据来判断异常**。


	当然，一个时间序列中可能出现多个异常点，这时候就要用到ESD(extreme Studentized deviate)检验。ESD检验可以看作是迭代的对数据进行Grubbs' test，每次检验一个异常点（计算偏离度，与关键值对比判断是否为异常，如果是异常则剔除出样本并进行下一轮迭代）。

	我们来看一个例子，下图是一个带有季节性的时间序列，每年的6月都有一个尖峰，我们在数据里人工加入了四个异常点（红圈标出），两个波峰两个波谷。
	[esd sample]

	在原数据上进行ESD检测的结果如下：
	[esd on original]

	可以看到检测漏过了两个尖峰异常，这是因为数据整体的向上的趋势和季节性尖峰对偏离度的计算造成了干扰。所以我们需要先对数据先进行时序分解，之后在分解结果的剩余项上进行ESD检测，这样就可以检测出所有的异常点了:
	[esd on residual]


	2. 均值变化
	均值变化指的是一段窗口期内的均值相比之前的水位有显著的变化。
	[com example]

	针对均值变化的一个常用检测方式是使用两个紧挨着的滑动窗口（观察窗口和检测窗口），用T-Test来判断检测窗口中的样本是否和观察窗口具有相同的均值。窗口大小需要按照实际的业务情况来决定（例如对于天级别的数据可以选择一个月为观察窗口，七天为检测窗口）。
	[com illustrate]

	T-Test检测【两个重叠波峰的示意图】


	3. 方差变化
	方差变化指的是一段窗口期内的数据方差相比之前的数据有了显著的变化。检测方式和均值变化相同也是用两个滑动窗口进行检测，不同的是这次我们用F-Test来检验两个窗口中的数据方差是否有明显差异。进行F-Test的时候先计算两个窗口内样本的方差，之后将方差的比值和F分布进行比对，如果方差的比值过大或者过小则判断为异常。

	[f_test]

	4. 持续变化
	我们关注的最后一种异常是数据在短期内并没有发生急剧的变化，但是在较长的一段时间内持续上涨或下降。针对这类异常我们通常需要用到一个时间跨度较大的滑动窗口，然后使用Mann Kendall Test(下称为MK-Test)来判断窗口内的数据是否单调增或单调减。使用MK-Test时我们先计算S，S统计了在比较窗口中任取两点，后一点和前一点的大小关系:

	[MK_formula_1]

	其中sgn函数的取值为：

	[sgn_value]

	当窗口内数据点的数量较大时（通常需要大于10个），用下式计算出的变量Z大致符合标准正态分布（原始的公式里还需要对数据中有重复数值情况进行调整，完整的实现可以参考文末链接中的代码），因此如果Z>2.32则表示99%的显著性下窗口内数据在单调递增。

	[mkz_formula]




代码： 



参考：
Grubbs Test: https://www.itl.nist.gov/div898/handbook/eda/section3/eda35h1.htm
extreme Studentized deviate: https://www.itl.nist.gov/div898/handbook/eda/section3/eda35h3.htm
F Test: https://www.itl.nist.gov/div898/handbook/eda/section3/eda359.htm
Mann Kendall Test: https://vsp.pnnl.gov/help/Vsample/Design_Trend_Mann_Kendall.htm